(ns ae.kmeans.core
  (:gen-class)
  (:require [ae.kmeans.lib :as lib]
            [ae.lib :as core-lib]
            [clojure.string :as s]
            [taoensso.timbre :as timbre]))

(defn -main [mode input-dir output-dir partitions params]
  (core-lib/setup-logging)
  (lib/parse-params params) ;; fail fast on bad params
  (core-lib/run "aws s3 ls" (core-lib/join-path input-dir "inputs.txt")) ;; fail fast if inputs.txt doesnt exist
  (let [ctx (lib/init-spark mode)]
    (try
      (let [partitions (read-string partitions)
            inputs (lib/process-file
                    ctx
                    (lib/compute-size input-dir)
                    (lib/input-file input-dir)
                    partitions)
            k (read-string (core-lib/get-key (lib/k-file input-dir)))
            model (lib/timeit "done with train-kmeans"
                    (lib/train inputs k (lib/parse-params params)))
            uuid (core-lib/uuid)
            datas (lib/timeit "done with get-data"
                    (lib/get-datas inputs model))
            users (lib/load-users input-dir)
            _ (lib/save-data-json users datas output-dir uuid)
            names (lib/load-names input-dir)
            pages (lib/load-pages input-dir)
            meta-data (lib/timeit "done with get-meta-data"
                        (lib/get-meta-data inputs model names pages uuid))
            _ (lib/save-meta-data-json meta-data output-dir)])
      (finally
        (if (= mode "single")
          (.stop ctx))))
    (core-lib/shutdown)))
